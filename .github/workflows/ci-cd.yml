name: CI/CD Pipeline

on:
    push:
        branches:
            - master
    pull_request:
        branches:
            - master

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Cache Composer Dependencies
      uses: actions/cache@v2
      with:
          path: vendor
          key: composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
              composer-

    - name: Install PHP
      uses: shivammathur/setup-php@v2
      with:
          php-version: 8.2

    - name: Install Dependencies
      run: composer install --no-interaction

    - name: Copy .env
      run: |
          echo "Copying .env.ci to .env..."
          cp .env.ci .env
          echo "Contents of .env:"
          cat .env

    - name: Reset APP_KEY
      run: sed -i '/^APP_KEY=/d' .env

    - name: Generate Application Key
      run: php artisan key:generate

    - name: Run Tests
      run: php artisan test
